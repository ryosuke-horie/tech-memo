## 概要
- Slackの導入を提案する
- Mattermostに比べたメリット・デメリットを調査

## Slackの基本的な情報
### 料金
https://slack.com/intl/ja-jp/pricing
- 一人あたり1050円
	- 50人なら毎月5万円
### Slackを導入するメリット
- 外部ツールとの連携のしやすさ
	- Slackに「アプリ」として追加することで導入できる
	- GitHubとの連携をスムーズに行える、GitHub Appなどが有名
	- 通知を飛ばしたりするのにLambdaなどのコードを書く工数を削減できる
- AWS等で実装しているLambdaを利用した通知のマネージド化
	- AWS ChatbotというAWSのリソースが存在する
	- メトリクス通知やアラートなどの通知をAWSにまるっと任せることが可能
	- 送信時のエラーなどを気にする必要がなくなる
	- 工数削減が期待できます
- ワークフロービルダーの機能による自動化プロセスをSlack上で作成可能

## Mattermostを利用し続けるリスクについて
### Mattermostのセキュリティ対策ができていない
2024年9月7日現在、Mattermostの最新版はv9.11.1となっています。(Rre-releaseではすでにv10がリリースされています)
https://github.com/mattermost/mattermost/releases/tag/v9.11.1

利用しているMattermotのバージョンは8.1.2であり、バージョンに乖離があります。
2023年9月9日リリースのバージョンです。

複数のセキュリティアップデートが無視された状態です。
現状のインフラチームや社内エンジニアのリソースを考えても定期的なアップデートに対応するリソースがなく、どこかのタイミングでメジャーバージョンに対応するための膨大な工数をかける必要が生じます。

すでにアナウンスされている内容で考えると
- v11でMySql(MariaDB)が非推奨になることが明記されています
	- MySQLからPostgreSQLへの移行が必要になります。
- v8 ~ v10 2つ分程度のメジャーバージョンアップへの対応
	- [upgradeガイド](https://docs.mattermost.com/upgrade/upgrading-mattermost-server.html)は出ています

### MattermostをホストしているEC2インスタンスのOSの保守期限
現在Mattermostを保守しているEC2のOSはAmazon Linux2となっています。
2025年6月30日にサポートが終了します。

こちらに関しても移行作業が必要で、膨大な工数がかかることが想定されます。


### EC2インスタンスの保守ができていない
充分なメトリクスの取得やアラートの設定がされていません。
9月3日にMattermostが動かなくなった件もEC2のメモリ使用率のメトリクスに対して適切なアラートが通知されるようにしておけば発生を防げた可能性があります。

また、OSやミドルウェア等サーバー内の依存関係もアップデートできるようにSSM等を採用して自動化するべきですが、できていないようです。

この状況ではセキュリティの問題は日を追うごとに増えていきます。


## Mattermostに関連するリソースのAWS構成図と評価
![[mattermost構成図.jpg]]
上記画像のような構成になっています。
- `ch.fs-revolution.info`のAレコードをALBに関連付けさせ名前解決
- ALBに対してWAFを設定
	- Ruleセットの適用なし
	- Cloudwatch等のログ出力の設定なし
	- 日本以外の複数の国からのアクセスと大量のリクエストの記録がある
		- 1週間で4.84Mのリクエスト数が報告されており、異常に多い
![[waf.jpg]]
- EC2をパブリックサブネットに配置している
	- SSHポートなどの開放をWorkspacesのIPに限定する以外には特に対応しておらず脆弱

### セキュリティ対策をするなら
Mattermostに対して十分なセキュリティ対策を進めるなら最低限以下のような作業が必要になります。
- EC2をprivate subnetに移動
- Nat GatewayをPublic Subnetに配置してトラフィックを経由させる
- WAFのルールセットを適用する
- WAFのログを収集する
- ネットワークACLを設定し、サブネットレベルでのトラフィック制御ルールを設定する
- Cloudwatchメトリクスの設定とアラートの設定および適切なメッセージをLambdaを利用してMattermostやメール等で通知
- SSMを利用してEC2のパッチアップデートに対応
- Mattemostのバージョンアップ対応
- Amazon Linux2から保守期限の長い適切なOSに移行
- VPCフローログの収集
- security hubの有効化
	- 関連サービスを有効化
		- GuardDuty
		- Inspector
		- Detective


### 上記のセキュリティ対策をフルで実行した場合のざっくりとした料金見積もり

月額273.44 USD
ざっくり1か月あたり約4万円がランニングコストとしてかかります。

これに加えて上記のセキュリティ対策を実施する工数・Mattermostのバージョンアップ対応・OSの移行・PostgreSQLへの移行などの工数を加味する必要があります。

Slackは一人あたり1050円です。
50人で52500円になります。

## 意見：MattermostからSlackへの移行を提案します。

チャットツールという性質上、機密性の高い情報がやり取りされる可能性が高いです。
つまりセキュリティ対策は入念に行われるべきです。
少なくとも今のMattermostはセキュリティ的に脆弱と言わざるを得ません。

また、Mattermostの保守にかかる工数も無視できません。
先日の障害対応に関して言えば最終的にMariaDBバックアップから復旧させることができましたが、原因の特定や修正までに5時間ほどかかっています。
対応された神尾さん、海田さん、インフラチームの人件費も