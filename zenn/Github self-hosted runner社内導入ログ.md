github selfhosted runnerの構築に苦しんでいたが、少なくとも会社でメンバーをある程度納得させられるようなところまで持っていけたと感じた。  
構築のパターンや方法を紹介している記事は多々ありましたが、Github セルフホストランナーの選定に悩んでるような記事をなかなか見かけなかったので共有します。  
  
## ■概要  
terraform-aws-github-runnerというTerraformを利用したossの利用とカスタマイズによってGithub Self hosted runnerを構築した。  
  
## ■背景  
Github actionsを導入し、使い始め1ヶ月程経過した。  
GitlabからGithubに移行したプロジェクトの自動テストがかなり充実していてciの実行時間が膨大になり、コスト面からセルフホストランナーを導入して検証していた。  
  
最初は社内に置いてある、オンプレにVMwareで構築したlinux環境をセルフホストランナーにして運用を始めた。  
  
■オンプレVMware環境で発生した課題  
社内のネットワークの影響をモロに受け、実行時間が大幅に伸びてしまう。  
会社のネットワークは午前中混雑していることが多く、その時間帯に実行してしまうと平気で2,3時間経っても終わらない場合があった。  
  
また、VMware上のLinux環境の数は固定のため、複数のPRが立った場合などでactionが渋滞するとエラーを吐き始め、手動でリトライする必要があり、自動テスト感がなかった。  
  
  
■調査・比較した内容  
上記の課題を解決するためにセルフホストランナーの実装パターンを調査し、比較しました。  
  
見かけたり思いついた選択肢とそれに対するざっくりとした個人的な印象を記載します  
  
1. githubがホストするデフォルトのランナーをそのまま利用する。  
- キャッシュやdocker imageの利用を深く考える必要がなく、シンプルで簡単な選択肢。  
- ただ、1分あたり0.008$のコストは会社にとっては割高で、今後別チームにgithub actionsを普及していった時にさらにコストが膨れ上がる可能性がある。  
2. オンプレサーバーを増やしてセルフホストランナーの数を増やして無理矢理対応  
- 別拠点に存在するオンプレサーバーを利用してセルフホストランナーの数を物理的に増やして対応。  
- 管理が面倒なのと別拠点の方とのやり取りが増えるため作業が増えそうなのでやりたくない。  
3. terraform-aws-github-runnerをカスタマイズして利用  
- EC2スポットインスタンスを、Lambdaで起動、終了、セルフホストランナー登録・解除を管理するため、他の選択肢に比べてコスト的な優位性がある。  
- 会社に馴染みがあるAWSで実装できる。  
- カスタマイズの余地があり、サンプル、ドキュメントが充実している。  
- デメリットに感じるのは社内にTerraformを利用した例がなく、使えるエンジニアが現状いないこと。  
	- 実装した自分しかわからない状況になるとメンテナンス性に難がある。  
1. k8sでセルフホストランナーを立てるパターン  
- Githubが推奨している方法の一つらしい。  
- Terraformと同様、k8sの採用例が社内になかった。  
- k8sについて個人的に触り部分を学習したがその程度で構築やアーキテクチャを考えるには奥が深すぎ、会社に提案できるイメージがわかなかった。
5. AWS codebuildによるマネージドGithub Self hosted Runnerの構築  
- マネージドでやってくれるところはかなり魅力的。  
- ただし、実行時間に対する料金が割と高く、githubがホストするランナーに比べてコスト的なメリットが薄かった。  
- AMIとかカスタマイズしてパフォーマンスを上げるような用途では活躍しそうなイメージ。  
  

## ■terraform-aws-github-runnerをカスタマイズして利用するパターンを採用  
上司などに状況と調査内容を報告し、  
コスト面のメリットが大きく、構築する工数の少なく、カスタマイズ性があって将来性もありそうなterraform-aws-github-runnerを提案しました。  
  
Terraformが入ることに若干懸念があるようですが、CICDの重要性を理解していただき、実装が楽そうなのとコスパが刺さったようで採用に至りました。  
  
  
## ■導入、実装のメモ  
[[Terraformの初期構築]]
  
## ■悩みポイント  
実行環境がec2なのでvpcが必要でネットワークの通信料のコストを考慮する必要がありました。(コストのためにセキュリティを捨てパブリックサブネットでciを実行するわけにいかないし、、、）  
  
Natgatewayを利用するとネットワークで処理したデータ量に対しての課金となりここの料金が膨れることが懸念に感じられました。  
最終的に、セルフホストランナー自体がまだ社内では様子見の構築であることと、ネットワーク通信料とセキュリティの兼ね合いからnatインスタンスを利用して構築しました。  
  
  
## ■構成図  
![[terraform-aws-github-runner-architecuture.jpg]]
## ■最後に  
個人的にはTerraformやイベントベースのawsアーキテクチャ、提案、構築などを経験できた最高の期間でした。  
今後、terraformだけでなくgithub runnerなどここに上げなかったものの社内への普及など課題は大量にありますが、学びがあればまた共有していこうと思います。